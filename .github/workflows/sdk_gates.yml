name: HELM SDK Gates

on:
  push:
    branches: [main]
    paths: ['sdk/**', 'api/**', 'examples/**', 'scripts/sdk/**', 'scripts/ci/sdk_*']
  pull_request:
    branches: [main]
    paths: ['sdk/**', 'api/**', 'examples/**', 'scripts/sdk/**', 'scripts/ci/sdk_*']

jobs:

  # ── SDK Drift Gate ────────────────────────────────────
  sdk-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: SDK drift check
        run: |
          # Verify generated files match committed files
          # Note: full gen.sh requires Docker; here we validate structure
          for f in sdk/ts/src/types.gen.ts sdk/python/helm_sdk/types_gen.py sdk/go/client/types_gen.go sdk/rust/src/types_gen.rs sdk/java/src/main/java/labs/mindburn/helm/TypesGen.java; do
            if [ ! -f "$f" ]; then
              echo "❌ Missing generated file: $f"
              exit 1
            fi
            if ! head -1 "$f" | grep -q "AUTO-GENERATED\|auto-generated"; then
              echo "❌ $f missing AUTO-GENERATED header"
              exit 1
            fi
          done
          echo "✅ All generated files present and marked"

  # ── TypeScript ────────────────────────────────────────
  sdk-typescript:
    runs-on: ubuntu-latest
    needs: sdk-drift
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install and build
        run: |
          cd sdk/ts
          npm ci --ignore-scripts
          npm run build
      - name: Pack check
        run: cd sdk/ts && npm pack --dry-run

  # ── Python ───────────────────────────────────────────
  sdk-python:
    runs-on: ubuntu-latest
    needs: sdk-drift
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install and import
        run: |
          cd sdk/python
          pip install -e . --quiet
          python -c "from helm_sdk import HelmClient; print('✅ import ok')"

  # ── Go ───────────────────────────────────────────────
  sdk-go:
    runs-on: ubuntu-latest
    needs: sdk-drift
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Build and test
        run: |
          cd sdk/go
          go build ./...
          go vet ./...

  # ── Rust ─────────────────────────────────────────────
  sdk-rust:
    runs-on: ubuntu-latest
    needs: sdk-drift
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build and test
        run: |
          cd sdk/rust
          cargo build
          cargo test

  # ── Java ─────────────────────────────────────────────
  sdk-java:
    runs-on: ubuntu-latest
    needs: sdk-drift
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Build
        run: |
          cd sdk/java
          mvn -q compile -DskipTests

  # ── OpenAPI Lint ─────────────────────────────────────
  openapi-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate OpenAPI spec
        run: |
          npx -y @redocly/cli lint api/openapi/helm.openapi.yaml --skip-rule no-unused-components
