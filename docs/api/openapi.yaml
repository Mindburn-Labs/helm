openapi: "3.0.3"
info:
  title: HELM Kernel API
  version: "0.1.0"
  description: |
    HELM Unified Canonical Standard v1.2 â€” Kernel API.
    Deterministic execution firewall with ProofGraph, receipt verification,
    and approval ceremony support.

servers:
  - url: http://localhost:8080
    description: Local development

paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: OK

  /api/v1/kernel/dispatch:
    post:
      summary: Dispatch a tool call through the kernel
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DispatchRequest"
      responses:
        "200":
          description: Tool call result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DispatchResponse"
        "403":
          description: Denied by governance

  /api/v1/kernel/approve:
    post:
      summary: Submit approval ceremony
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CeremonyRequest"
      responses:
        "200":
          description: Approval accepted
        "403":
          description: Ceremony validation failed

  /api/v1/trust/keys/add:
    post:
      summary: Add a trusted signing key
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddKeyRequest"
      responses:
        "200":
          description: Key added

  /api/v1/trust/keys/revoke:
    post:
      summary: Revoke a trusted signing key
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RevokeKeyRequest"
      responses:
        "200":
          description: Key revoked

  /api/v1/memory/ingest:
    post:
      summary: Ingest data (stub in OSS)
      responses:
        "501":
          description: Not available in OSS kernel mode

  /api/v1/memory/search:
    post:
      summary: Search memory (stub in OSS)
      responses:
        "501":
          description: Not available in OSS kernel mode

  /v1/chat/completions:
    post:
      summary: OpenAI-compatible proxy (optional)
      description: Requires HELM_ENABLE_OPENAI_PROXY=1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OpenAIChatRequest"
      responses:
        "200":
          description: Chat completion response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OpenAIChatResponse"

  /mcp/v1/capabilities:
    get:
      summary: List MCP capabilities
      responses:
        "200":
          description: Capability manifest

  /mcp/v1/execute:
    post:
      summary: Execute MCP tool call
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MCPToolCallRequest"
      responses:
        "200":
          description: Execution result

  # --- Operator Console API (DX-004) ---

  /api/obligations:
    get:
      summary: List governance obligations
      description: Returns all active obligations for the current tenant.
      responses:
        "200":
          description: Array of obligations

  /api/receipts:
    get:
      summary: List execution receipts
      description: Paginated list of signed receipts from tool executions.
      responses:
        "200":
          description: Array of receipts

  /api/intents:
    get:
      summary: List execution intents
      description: Returns pending and completed execution intents.
      responses:
        "200":
          description: Array of intents

  /api/approvals:
    get:
      summary: List approval ceremonies
      description: Returns pending and completed approval ceremonies.
      responses:
        "200":
          description: Array of approvals

  /api/modules:
    get:
      summary: List installed modules
      description: Returns registered kernel modules and their status.
      responses:
        "200":
          description: Array of modules

  /api/registry/list:
    get:
      summary: List registry entries
      description: Returns available tools and modules in the registry.
      responses:
        "200":
          description: Registry listing

  /api/registry/install:
    post:
      summary: Install a module from registry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                module_id:
                  type: string
      responses:
        "200":
          description: Installation result

  /api/compliance/report:
    get:
      summary: Generate compliance report
      description: Returns current compliance posture across all governance rules.
      responses:
        "200":
          description: Compliance report

  /api/compliance/obligations:
    get:
      summary: List compliance obligations (JSON)
      responses:
        "200":
          description: Obligation details

  /api/policies:
    get:
      summary: List active policies
      description: Returns all governance policies configured for the tenant.
      responses:
        "200":
          description: Array of policies

  /api/policies/simulate:
    post:
      summary: Simulate policy evaluation
      description: "MC-02: Run a what-if policy simulation without executing."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tool_name:
                  type: string
                params:
                  type: object
      responses:
        "200":
          description: Simulation result

  /api/slo/definitions:
    get:
      summary: List SLO definitions
      responses:
        "200":
          description: Array of SLO definitions

  /api/slo/status:
    get:
      summary: Get SLO status
      responses:
        "200":
          description: Current SLO compliance status

  /api/alerts:
    get:
      summary: List active alerts
      responses:
        "200":
          description: Array of alerts

  /api/cost/summary:
    get:
      summary: Get cost summary
      description: Returns aggregated cost metrics for tool executions.
      responses:
        "200":
          description: Cost summary

  /api/metrics/dashboard:
    get:
      summary: Get metrics dashboard data
      description: Returns key operational metrics for the console dashboard.
      responses:
        "200":
          description: Dashboard metrics

  /api/ops/chaos/inject:
    post:
      summary: Inject chaos event (admin only)
      description: "CONSOLE-001: Requires admin role. Reduces error budget for testing."
      responses:
        "200":
          description: Chaos injected
        "401":
          description: Authentication required
        "403":
          description: Admin role required

  /api/verify/{pack_id}:
    get:
      summary: Verify an evidence pack
      parameters:
        - name: pack_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Verification result

  /api/auth/login:
    post:
      summary: Initiate authentication
      responses:
        "200":
          description: Login redirect or token

  /api/v1/credentials/status:
    get:
      summary: Get credential connection status
      description: Returns connection status for all configured AI providers.
      responses:
        "200":
          description: Array of credential statuses

  /api/admin/tenants:
    get:
      summary: List tenants (admin)
      responses:
        "200":
          description: Array of tenants

  /api/admin/audit/export:
    get:
      summary: Export audit log (admin)
      responses:
        "200":
          description: Audit export data

components:
  schemas:
    DispatchRequest:
      type: object
      required: [tool_name, params]
      properties:
        tool_name:
          type: string
        params:
          type: object

    DispatchResponse:
      type: object
      properties:
        result:
          type: object
        error:
          type: string

    CeremonyRequest:
      type: object
      required: [decision_id, timelock_ms, hold_ms, ui_summary_hash, signature]
      properties:
        decision_id:
          type: string
        timelock_ms:
          type: integer
        hold_ms:
          type: integer
        ui_summary_hash:
          type: string
        challenge_hash:
          type: string
        response_hash:
          type: string
        lamport_height:
          type: integer
        signer_key_id:
          type: string
        signature:
          type: string

    AddKeyRequest:
      type: object
      required: [tenant_id, key_id, public_key]
      properties:
        tenant_id:
          type: string
        key_id:
          type: string
        public_key:
          type: string
          description: Hex-encoded Ed25519 public key

    RevokeKeyRequest:
      type: object
      required: [tenant_id, key_id]
      properties:
        tenant_id:
          type: string
        key_id:
          type: string

    OpenAIChatRequest:
      type: object
      required: [messages]
      properties:
        model:
          type: string
        messages:
          type: array
          items:
            $ref: "#/components/schemas/OpenAIMessage"

    OpenAIChatResponse:
      type: object
      properties:
        id:
          type: string
        choices:
          type: array
          items:
            type: object

    OpenAIMessage:
      type: object
      properties:
        role:
          type: string
        content:
          type: string

    MCPToolCallRequest:
      type: object
      properties:
        method:
          type: string
        params:
          type: object
