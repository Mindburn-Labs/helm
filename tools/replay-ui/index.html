<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELM ProofGraph Viewer</title>
    <style>
        :root {
            --bg: #0d1117;
            --surface: #161b22;
            --border: #30363d;
            --text: #e6edf3;
            --dim: #8b949e;
            --green: #3fb950;
            --red: #f85149;
            --blue: #58a6ff;
            --yellow: #d29922;
            --purple: #bc8cff;
            --cyan: #39d353;
            --mono: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh; display: flex; flex-direction: column;
        }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        header {
            padding: 16px 24px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 16px;
        }
        header h1 { font-size: 18px; font-weight: 600; }
        header .badge {
            font-size: 11px; padding: 2px 8px; border-radius: 12px;
            font-family: var(--mono); font-weight: 500;
        }
        header .badge.pass { background: rgba(63,185,80,.15); color: var(--green); border: 1px solid rgba(63,185,80,.3); }
        header .badge.fail { background: rgba(248,81,73,.15); color: var(--red); border: 1px solid rgba(248,81,73,.3); }
        #file-input {
            display: none;
        }
        .drop-label {
            margin-left: auto; font-size: 13px; color: var(--dim); cursor: pointer;
            padding: 6px 14px; border: 1px dashed var(--border); border-radius: 6px;
            transition: border-color .2s;
        }
        .drop-label:hover { border-color: var(--blue); color: var(--blue); }

        /* â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .summary {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px; padding: 20px 24px;
        }
        .summary-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; padding: 14px 16px;
        }
        .summary-card .label { font-size: 11px; color: var(--dim); text-transform: uppercase; letter-spacing: .5px; }
        .summary-card .value { font-size: 18px; font-weight: 600; margin-top: 4px; font-family: var(--mono); }
        .summary-card .hash { font-size: 11px; font-family: var(--mono); color: var(--cyan); word-break: break-all; margin-top: 4px; }

        /* â”€â”€ Graph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .graph-container {
            flex: 1; padding: 0 24px 24px; overflow-y: auto;
        }
        .section-title {
            font-size: 13px; color: var(--dim); text-transform: uppercase;
            letter-spacing: .5px; margin: 20px 0 12px; padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .entries {
            display: flex; flex-direction: column; gap: 6px;
        }
        .entry {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 6px; padding: 10px 14px;
            display: grid; grid-template-columns: 24px 1fr auto; align-items: center; gap: 10px;
            font-size: 13px; transition: border-color .15s;
        }
        .entry:hover { border-color: var(--blue); }
        .entry .icon { font-size: 16px; }
        .entry .path { font-family: var(--mono); font-size: 12px; }
        .entry .meta { font-family: var(--mono); font-size: 11px; color: var(--dim); text-align: right; }
        .entry .sha { font-family: var(--mono); font-size: 10px; color: var(--dim); grid-column: 2/4; word-break: break-all; }

        /* â”€â”€ Gates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .gate {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 6px; padding: 10px 14px;
            display: grid; grid-template-columns: 24px auto 1fr auto; align-items: center; gap: 10px;
            font-size: 13px;
        }
        .gate .id { font-family: var(--mono); font-weight: 600; font-size: 12px; }
        .gate .status-tag {
            font-size: 10px; padding: 1px 6px; border-radius: 4px;
            font-family: var(--mono); font-weight: 500;
        }
        .gate .status-tag.pass { background: rgba(63,185,80,.15); color: var(--green); }
        .gate .status-tag.fail { background: rgba(248,81,73,.15); color: var(--red); }
        .gate .status-tag.skip { background: rgba(210,153,34,.15); color: var(--yellow); }
        .gate .dur { font-family: var(--mono); font-size: 11px; color: var(--dim); }

        /* â”€â”€ Drop Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dropzone {
            flex: 1; display: flex; align-items: center; justify-content: center;
            padding: 60px; text-align: center;
        }
        .dropzone-inner {
            border: 2px dashed var(--border); border-radius: 12px;
            padding: 60px 40px; max-width: 500px; width: 100%;
            transition: border-color .2s, background .2s;
        }
        .dropzone-inner.dragover { border-color: var(--blue); background: rgba(88,166,255,.05); }
        .dropzone-inner h2 { font-size: 18px; margin-bottom: 8px; }
        .dropzone-inner p { font-size: 13px; color: var(--dim); }
        .dropzone-inner code { font-family: var(--mono); font-size: 12px; color: var(--blue); }
    </style>
</head>
<body>
    <header>
        <h1>HELM ProofGraph Viewer</h1>
        <span id="verdict-badge" class="badge" style="display:none"></span>
        <label class="drop-label" for="file-input">Load JSON...</label>
        <input type="file" id="file-input" accept=".json">
    </header>

    <div id="content">
        <div class="dropzone" id="dropzone">
            <div class="dropzone-inner" id="drop-inner">
                <h2>Drop an Evidence Pack JSON</h2>
                <p>Load <code>00_INDEX.json</code>, <code>01_SCORE.json</code>, or a <code>verify.json</code> output to visualize.</p>
                <p style="margin-top:12px;font-size:12px;color:var(--dim)">
                    Generate with: <code>npx @mindburn/helm --ci --bundle &lt;path&gt; 2&gt;/dev/null &gt; verify.json</code>
                </p>
            </div>
        </div>
    </div>

    <script>
    // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let loadedData = null;

    // â”€â”€â”€ File Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const fileInput = document.getElementById('file-input');
    const dropzone = document.getElementById('dropzone');
    const dropInner = document.getElementById('drop-inner');

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) loadFile(e.target.files[0]);
    });

    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropInner.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => dropInner.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropInner.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) loadFile(e.dataTransfer.files[0]);
    });

    function loadFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                loadedData = data;
                render(data);
            } catch (err) {
                alert('Failed to parse JSON: ' + err.message);
            }
        };
        reader.readAsText(file);
    }

    // â”€â”€â”€ Detect & Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render(data) {
        // Detect file type
        if (data.verdict || data.schema_version) {
            renderVerifyResult(data);
        } else if (data.entries && data.format_version) {
            renderIndex(data);
        } else if (data.gate_results) {
            renderScore(data);
        } else {
            renderGeneric(data);
        }
    }

    function renderVerifyResult(r) {
        const badge = document.getElementById('verdict-badge');
        badge.textContent = r.verdict;
        badge.className = 'badge ' + (r.verdict === 'PASS' ? 'pass' : 'fail');
        badge.style.display = '';

        const content = document.getElementById('content');
        content.innerHTML = '';

        // Summary cards
        const summary = el('div', 'summary');
        summary.appendChild(summaryCard('Verdict', r.verdict));
        summary.appendChild(summaryCard('Profile', r.profile || 'â€”'));
        summary.appendChild(summaryCard('Duration', (r.timing_ms || 0) + 'ms'));
        if (r.roots) {
            const mc = summaryCard('Bundle Root', '');
            mc.querySelector('.value').textContent = '';
            const h = el('div', 'hash');
            h.textContent = r.roots.manifest_root_hash || 'â€”';
            mc.appendChild(h);
            summary.appendChild(mc);
            const mk = summaryCard('Merkle Root', '');
            mk.querySelector('.value').textContent = '';
            const h2 = el('div', 'hash');
            h2.textContent = r.roots.merkle_root || 'â€”';
            mk.appendChild(h2);
            summary.appendChild(mk);
        }
        content.appendChild(summary);

        // Graph container
        const graph = el('div', 'graph-container');

        // Checks
        if (r.structure || r.hash_chain || r.signature) {
            graph.appendChild(sectionTitle('Verification Checks'));
            const checks = el('div', 'entries');
            if (r.structure) checks.appendChild(checkEntry('Structure', r.structure.pass, r.structure.dirCount + ' dirs'));
            if (r.hash_chain) checks.appendChild(checkEntry('Hash Chain', r.hash_chain.pass, r.hash_chain.verifiedEntries + '/' + r.hash_chain.totalEntries + ' entries'));
            if (r.signature) checks.appendChild(checkEntry('Signature', r.signature.pass, r.signature.signerID || r.signature.reason || ''));
            if (r.attestation) checks.appendChild(checkEntry('Attestation', r.attestation.pass, r.attestation.reason || ''));
            graph.appendChild(checks);
        }

        // Gates
        if (r.gates && r.gates.gateResults) {
            graph.appendChild(sectionTitle('Gates (' + r.gates.passedGates + '/' + r.gates.totalGates + ')'));
            const gates = el('div', 'entries');
            for (const g of r.gates.gateResults) {
                gates.appendChild(gateEntry(g));
            }
            graph.appendChild(gates);
        }

        content.appendChild(graph);
    }

    function renderIndex(idx) {
        const badge = document.getElementById('verdict-badge');
        badge.style.display = 'none';

        const content = document.getElementById('content');
        content.innerHTML = '';

        const summary = el('div', 'summary');
        summary.appendChild(summaryCard('Format', idx.format_version || 'â€”'));
        summary.appendChild(summaryCard('Run ID', idx.run_id || 'â€”'));
        summary.appendChild(summaryCard('Profile', idx.profile || 'â€”'));
        summary.appendChild(summaryCard('Entries', String(idx.entries.length)));
        content.appendChild(summary);

        const graph = el('div', 'graph-container');
        graph.appendChild(sectionTitle('Index Entries'));
        const entries = el('div', 'entries');
        for (const e of idx.entries) {
            entries.appendChild(indexEntry(e));
        }
        graph.appendChild(entries);
        content.appendChild(graph);
    }

    function renderScore(score) {
        const badge = document.getElementById('verdict-badge');
        badge.textContent = score.pass ? 'PASS' : 'FAIL';
        badge.className = 'badge ' + (score.pass ? 'pass' : 'fail');
        badge.style.display = '';

        const content = document.getElementById('content');
        content.innerHTML = '';

        const summary = el('div', 'summary');
        summary.appendChild(summaryCard('Run ID', score.run_id || 'â€”'));
        summary.appendChild(summaryCard('Profile', score.profile || 'â€”'));
        summary.appendChild(summaryCard('Gates', String(score.gate_results.length)));
        content.appendChild(summary);

        const graph = el('div', 'graph-container');
        graph.appendChild(sectionTitle('Gate Results'));
        const gates = el('div', 'entries');
        for (const g of score.gate_results) {
            gates.appendChild(gateEntry(g));
        }
        graph.appendChild(gates);
        content.appendChild(graph);
    }

    function renderGeneric(data) {
        const content = document.getElementById('content');
        content.innerHTML = '<div class="graph-container"><pre style="font-family:var(--mono);font-size:12px;color:var(--dim);white-space:pre-wrap">' +
            escapeHtml(JSON.stringify(data, null, 2)) + '</pre></div>';
    }

    // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function el(tag, cls) {
        const e = document.createElement(tag);
        if (cls) e.className = cls;
        return e;
    }

    function summaryCard(label, value) {
        const card = el('div', 'summary-card');
        const l = el('div', 'label'); l.textContent = label;
        const v = el('div', 'value'); v.textContent = value;
        card.appendChild(l);
        card.appendChild(v);
        return card;
    }

    function sectionTitle(text) {
        const t = el('div', 'section-title');
        t.textContent = text;
        return t;
    }

    function checkEntry(label, pass, detail) {
        const e = el('div', 'entry');
        const icon = el('span', 'icon'); icon.textContent = pass ? 'âœ“' : 'âœ—'; icon.style.color = pass ? 'var(--green)' : 'var(--red)';
        const path = el('span', 'path'); path.textContent = label;
        const meta = el('span', 'meta'); meta.textContent = detail;
        e.appendChild(icon);
        e.appendChild(path);
        e.appendChild(meta);
        return e;
    }

    function indexEntry(entry) {
        const e = el('div', 'entry');
        const icon = el('span', 'icon'); icon.textContent = entry.kind === 'helm:log' ? 'ðŸ“„' : entry.kind === 'helm:report' ? 'ðŸ“Š' : 'ðŸ“';
        const path = el('span', 'path'); path.textContent = entry.path;
        const meta = el('span', 'meta'); meta.textContent = formatBytes(entry.size_bytes) + (entry.kind ? ' Â· ' + entry.kind : '');
        const sha = el('div', 'sha'); sha.textContent = 'sha256:' + entry.sha256;
        e.appendChild(icon);
        e.appendChild(path);
        e.appendChild(meta);
        e.appendChild(sha);
        return e;
    }

    function gateEntry(g) {
        const e = el('div', 'gate');
        const status = g.status || (g.pass ? 'pass' : 'fail');
        const icon = el('span', 'icon'); icon.textContent = status === 'pass' ? 'âœ“' : status === 'skip' ? 'âŠ˜' : 'âœ—';
        icon.style.color = status === 'pass' ? 'var(--green)' : status === 'skip' ? 'var(--yellow)' : 'var(--red)';
        const id = el('span', 'id'); id.textContent = g.gate_id;
        const tag = el('span', 'status-tag ' + status); tag.textContent = status;
        const dur = el('span', 'dur'); dur.textContent = (g.metrics?.duration_ms || 0) + 'ms';
        e.appendChild(icon);
        e.appendChild(id);
        e.appendChild(tag);
        e.appendChild(dur);
        if (g.reasons && g.reasons.length > 0) {
            const reasons = el('div', 'sha');
            reasons.style.color = 'var(--red)';
            reasons.textContent = g.reasons.join(', ');
            e.appendChild(reasons);
        }
        return e;
    }

    function formatBytes(bytes) {
        if (!bytes) return 'â€”';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / 1048576).toFixed(1) + ' MB';
    }

    function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    </script>
</body>
</html>
